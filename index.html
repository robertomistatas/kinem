import React, { useState, useEffect } from 'react';

// --- Función de Validación y Formateo de RUT Chileno ---
const validarYFormatearRut = (rutCompleto) => {
  if (!rutCompleto) return { valido: false, formateado: '', error: '' };

  // Limpiar RUT de puntos y guión, y convertir K a mayúscula
  rutCompleto = rutCompleto.replace(/\./g, '').replace(/-/g, '').toUpperCase();

  // Separar cuerpo y dígito verificador
  let cuerpo = rutCompleto.slice(0, -1);
  let dv = rutCompleto.slice(-1);

  // Validar formato inicial (solo números en cuerpo, número o K en dv)
  if (!/^\d+$/.test(cuerpo) || !/^[\dkK]$/.test(dv)) {
      return { valido: false, formateado: rutCompleto, error: 'Formato inválido' };
  }

  // Calcular dígito verificador esperado
  let suma = 0;
  let multiplo = 2;
  for (let i = cuerpo.length - 1; i >= 0; i--) {
    suma += parseInt(cuerpo.charAt(i), 10) * multiplo;
    multiplo = multiplo === 7 ? 2 : multiplo + 1;
  }
  const dvEsperado = 11 - (suma % 11);
  const dvCalculado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();

  // Comparar dígito verificador
  const esValido = dv === dvCalculado;

  // Formatear RUT (ej: 12.345.678-9)
  let rutFormateado = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  rutFormateado += '-' + dv;

  return {
    valido: esValido,
    formateado: rutFormateado,
    error: esValido ? '' : 'RUT inválido'
  };
};


// Componente reutilizable para campos del formulario
// Añadido prop 'error' para mostrar mensajes de validación
function FormField({ label, id, type = 'text', value, onChange, required = false, rows, error = '' }) {
  const InputComponent = type === 'textarea' ? 'textarea' : 'input';
  const errorClass = error ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : 'border-gray-300 focus:border-blue-500 focus:ring-blue-500';

  return (
    <div className="mb-4">
      <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">
        {label}{required && <span className="text-red-500">*</span>}
      </label>
      <InputComponent
        type={type}
        id={id}
        name={id}
        value={value}
        onChange={onChange}
        required={required}
        rows={rows} // Solo para textarea
        className={`mt-1 block w-full px-3 py-2 bg-white border rounded-md shadow-sm focus:outline-none sm:text-sm ${errorClass}`}
        aria-invalid={!!error} // Accesibilidad: indica si el campo es inválido
        aria-describedby={error ? `${id}-error` : undefined} // Accesibilidad: asocia el error con el input
      />
      {/* Mostrar mensaje de error */}
      {error && <p id={`${id}-error`} className="mt-1 text-xs text-red-600">{error}</p>}
    </div>
  );
}

// Componente principal de la aplicación
function App() {
  // Estado para almacenar los datos del paciente - Añadido ODA
  const [patientData, setPatientData] = useState({
    nombre: '',
    rut: '', // El RUT se guarda sin formato aquí
    oda: '',
    direccion: '',
    telefono: '',
    edad: '',
    diagnostico: '',
    antecedentes: '',
    examenes: '',
    evaluacionInicial: '',
    evaluacionFinal: '',
    prestaciones: [{ fecha: '', detalle: '' }]
  });

  // Estado para el RUT formateado que se muestra en el input
  const [rutDisplay, setRutDisplay] = useState('');
  // Estado para el error de validación del RUT
  const [rutError, setRutError] = useState('');

  // Manejador específico para el campo RUT
  const handleRutChange = (e) => {
    const valorInput = e.target.value;
    // Actualizar el valor mostrado inmediatamente
    setRutDisplay(valorInput);

    // Validar y formatear
    const { valido, formateado, error } = validarYFormatearRut(valorInput);

    // Actualizar el estado del RUT (sin formato) y el error
    // Solo actualiza el estado 'patientData.rut' si es potencialmente válido o vacío
    // para no guardar basura, pero siempre actualiza el error.
    if (valorInput === '' || /^[0-9kK.-]*$/.test(valorInput)) {
        // Limpia el RUT antes de guardarlo en el estado principal
        const rutLimpio = valorInput.replace(/[.-]/g, '').toUpperCase();
        setPatientData(prevData => ({
            ...prevData,
            rut: rutLimpio // Guardar RUT limpio (sin puntos ni guión)
        }));
    }
     setRutError(error); // Actualizar el mensaje de error

     // Si es válido, actualiza el display con el formato correcto
     // (esto podría hacerse también en un evento onBlur para mejor UX)
     // if (valido) {
     //   setRutDisplay(formateado);
     // }
  };

   // Efecto para validar el RUT cuando el valor limpio cambia (opcional, podría hacerse solo en handleRutChange)
   useEffect(() => {
        const { valido, formateado, error } = validarYFormatearRut(patientData.rut);
        setRutError(error);
        // Podrías autocompletar el formato aquí si quisieras, aunque puede ser molesto al escribir
        // if (valido && patientData.rut) {
        //    setRutDisplay(formateado);
        // }
   }, [patientData.rut]);


  // Manejador para cambios en los inputs generales (excluye RUT)
  const handleChange = (e) => {
    const { name, value } = e.target;
     // Asegurarse de no manejar el RUT aquí si se usa handleRutChange
     if (name === 'rut') return;

    setPatientData(prevData => ({
      ...prevData,
      [name]: value
    }));
  };

  // Manejador para cambios en las prestaciones
  const handlePrestacionChange = (index, e) => {
    const { name, value } = e.target;
    const list = [...patientData.prestaciones];
    list[index][name] = value;
    setPatientData(prevData => ({
      ...prevData,
      prestaciones: list
    }));
  };

  // Añadir una nueva fila de prestación
  const handleAddPrestacion = () => {
    setPatientData(prevData => ({
      ...prevData,
      prestaciones: [...prevData.prestaciones, { fecha: '', detalle: '' }]
    }));
  };

  // Eliminar una fila de prestación
  const handleRemovePrestacion = (index) => {
    const list = [...patientData.prestaciones];
    if (list.length > 1) { // No permitir eliminar la última fila
        list.splice(index, 1);
        setPatientData(prevData => ({
        ...prevData,
        prestaciones: list
        }));
    }
  };

  // Manejador para el envío del formulario
  const handleSubmit = (e) => {
    e.preventDefault();

    // *** Re-validar RUT antes de enviar ***
    const { valido, error } = validarYFormatearRut(patientData.rut);
    setRutError(error); // Asegurarse que el error esté actualizado

    if (!valido && patientData.rut) { // Si hay RUT ingresado y no es válido
      console.error("Error: El RUT ingresado no es válido.");
      // Opcional: Enfocar el campo RUT
      document.getElementById('rut')?.focus();
      return; // Detener el envío
    }

    // Si el RUT es válido o está vacío (si no es requerido), proceder
    console.log("Datos de la ficha (RUT validado):", {
        ...patientData,
        // Podrías querer guardar el RUT formateado si lo prefieres
        // rut: validarYFormatearRut(patientData.rut).formateado
    });

    // Mostrar modal de éxito
    const modal = document.getElementById('successModal');
    if (modal) modal.classList.remove('hidden');
    setTimeout(() => {
        if (modal) modal.classList.add('hidden');
    }, 3000);
  };

  // Colores
  const primaryColor = 'blue-600';
  const accentColor = 'teal-500';
  const headerBgColor = `bg-${primaryColor}`;
  const headerTextColor = 'text-white';
  const buttonBgColor = `bg-${accentColor}`;
  const buttonHoverBgColor = `hover:bg-${accentColor.split('-')[0]}-600`;

  // URL del logo
  const logoUrl = "https://static.wixstatic.com/media/1831cb_7f3e8c943c604e4fa3004279321aab09%7Emv2.png/v1/fill/w_180%2Ch_180%2Clg_1%2Cusm_0.66_1.00_0.01/1831cb_7f3e8c943c604e4fa3004279321aab09%7Emv2.png";

  return (
    <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans">
      <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
        {/* Encabezado con Logo */}
        <header className={`${headerBgColor} ${headerTextColor} p-4 sm:p-6 flex justify-between items-center`}>
          <div>
            <h1 className="text-2xl sm:text-3xl font-bold">Kinem - Ficha Kinésica Digital</h1>
            <p className="mt-1 text-sm opacity-90">Ingreso y gestión de datos de pacientes</p>
          </div>
          <img
             src={logoUrl}
             alt="Logo Kinem"
             className="h-10 sm:h-12 rounded"
             onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/120x40/cccccc/ffffff?text=Logo+Error'; }}
           />
        </header>

        {/* Formulario */}
        <form onSubmit={handleSubmit} className="p-4 sm:p-6 space-y-6">

          {/* Sección Datos Personales - Campo RUT con validación */}
          <section className="border border-gray-200 rounded-md p-4">
            <h2 className={`text-xl font-semibold mb-4 text-${primaryColor}`}>Datos del Paciente</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <FormField label="Nombre Completo" id="nombre" value={patientData.nombre} onChange={handleChange} required />
              {/* Campo RUT modificado para usar el handler específico y mostrar error */}
              <FormField
                 label="RUT"
                 id="rut"
                 value={rutDisplay} // Mostrar valor formateado/input directo
                 onChange={handleRutChange} // Usar handler específico
                 required
                 error={rutError} // Pasar el mensaje de error
                 />
              <FormField label="ODA" id="oda" value={patientData.oda} onChange={handleChange} />
              <div className="md:col-span-2">
                 <FormField label="Dirección" id="dirección" value={patientData.dirección} onChange={handleChange} />
              </div>
              <FormField label="Teléfono" id="telefono" type="tel" value={patientData.telefono} onChange={handleChange} />
              <FormField label="Edad" id="edad" type="number" value={patientData.edad} onChange={handleChange} />
            </div>
          </section>

          {/* Resto de las secciones sin cambios */}
          <section className="border border-gray-200 rounded-md p-4">
            <h2 className={`text-xl font-semibold mb-4 text-${primaryColor}`}>Información Clínica</h2>
             <FormField label="Diagnóstico Médico" id="diagnostico" type="textarea" rows={3} value={patientData.diagnostico} onChange={handleChange} required />
             <FormField label="Antecedentes Clínicos Relevantes" id="antecedentes" type="textarea" rows={4} value={patientData.antecedentes} onChange={handleChange} />
             <FormField label="Exámenes Auxiliares (Radiografías, Resonancias, etc.)" id="examenes" type="textarea" rows={4} value={patientData.examenes} onChange={handleChange} />
          </section>

           <section className="border border-gray-200 rounded-md p-4">
             <h2 className={`text-xl font-semibold mb-4 text-${primaryColor}`}>Evaluaciones Kinésicas</h2>
             <FormField label="Evaluación Inicial" id="evaluacionInicial" type="textarea" rows={5} value={patientData.evaluacionInicial} onChange={handleChange} required />
             <FormField label="Evaluación Final (al alta)" id="evaluacionFinal" type="textarea" rows={5} value={patientData.evaluacionFinal} onChange={handleChange} />
           </section>

          <section className="border border-gray-200 rounded-md p-4">
            <h2 className={`text-xl font-semibold mb-4 text-${primaryColor}`}>Registro de Prestaciones / Sesiones</h2>
            <div className="space-y-3">
              {patientData.prestaciones.map((prestacion, index) => (
                <div key={index} className="flex flex-col sm:flex-row items-start sm:items-center gap-3 p-3 border border-gray-100 rounded bg-gray-50">
                  <div className="flex-grow w-full sm:w-auto">
                     <label htmlFor={`fecha-${index}`} className="block text-xs font-medium text-gray-600 mb-1">Fecha {index + 1}</label>
                     <input
                       type="date"
                       id={`fecha-${index}`}
                       name="fecha"
                       value={prestacion.fecha}
                       onChange={(e) => handlePrestacionChange(index, e)}
                       className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                     />
                  </div>
                   <div className="flex-grow w-full">
                     <label htmlFor={`detalle-${index}`} className="block text-xs font-medium text-gray-600 mb-1">Prestaciones / Observaciones {index + 1}</label>
                     <textarea
                       id={`detalle-${index}`}
                       name="detalle"
                       rows={2}
                       value={prestacion.detalle}
                       onChange={(e) => handlePrestacionChange(index, e)}
                       className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                       placeholder="Ej: Ejercicios isométricos, Masoterapia, Ultrasonido..."
                     />
                   </div>
                  {patientData.prestaciones.length > 1 && (
                    <button
                      type="button"
                      onClick={() => handleRemovePrestacion(index)}
                      className="mt-2 sm:mt-0 sm:ml-2 px-3 py-2 bg-red-500 text-white text-xs font-medium rounded-md shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 self-start sm:self-center"
                      aria-label={`Eliminar prestación ${index + 1}`}
                    >
                      Eliminar
                    </button>
                  )}
                </div>
              ))}
            </div>
            <button
              type="button"
              onClick={handleAddPrestacion}
              className={`mt-4 px-4 py-2 ${buttonBgColor} text-white text-sm font-medium rounded-md shadow-sm ${buttonHoverBgColor} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${accentColor.split('-')[0]}-500`}
            >
              Añadir Sesión
            </button>
          </section>

          {/* Botón de Guardar */}
          <div className="flex justify-end pt-6">
            <button
              type="submit"
              className={`px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white ${headerBgColor} hover:bg-${primaryColor.split('-')[0]}-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${primaryColor}`}
            >
              Guardar Ficha
            </button>
          </div>
        </form>
      </div>

       {/* Modal de éxito simple */}
       <div id="successModal" className="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
         <div className="bg-white p-5 rounded-lg shadow-xl text-center">
           <h3 className="text-lg font-medium text-gray-900">¡Éxito!</h3>
           <div className="mt-2">
             <p className="text-sm text-gray-500">
               Ficha guardada (simulado). Revisa la consola para ver los datos.
             </p>
           </div>
         </div>
       </div>
    </div>
  );
}

export default App;

// Validación de teléfono
const validarTelefono = (telefono) => {
  const telefonoLimpio = telefono.replace(/\D/g, '');
  return /^(\+?56|0)?[2-9]\d{8}$/.test(telefonoLimpio);
};

// Validación de edad
const validarEdad = (edad) => {
  const edadNum = parseInt(edad);
  return edadNum >= 0 && edadNum <= 120;
};

// Estado para errores adicionales
const [errores, setErrores] = useState({
  telefono: '',
  edad: ''
});

// Modificar handleChange para incluir validaciones
const handleChange = (e) => {
  const { name, value } = e.target;
  if (name === 'rut') return;

  setPatientData(prevData => ({
    ...prevData,
    [name]: value
  }));

  // Validaciones específicas
  if (name === 'telefono') {
    setErrores(prev => ({
      ...prev,
      telefono: value && !validarTelefono(value) ? 'Formato de teléfono inválido' : ''
    }));
  } else if (name === 'edad') {
    setErrores(prev => ({
      ...prev,
      edad: value && !validarEdad(value) ? 'Edad debe estar entre 0 y 120 años' : ''
    }));
  }
};

// Modificar handleSubmit para validación completa
const handleSubmit = (e) => {
  e.preventDefault();
  
  // Validar todos los campos requeridos
  const camposRequeridos = ['nombre', 'rut', 'diagnostico', 'evaluacionInicial'];
  const camposFaltantes = camposRequeridos.filter(campo => !patientData[campo]);
  
  if (camposFaltantes.length > 0) {
    alert('Por favor complete todos los campos obligatorios');
    return;
  }

  // Validar RUT
  const { valido, error } = validarYFormatearRut(patientData.rut);
  setRutError(error);

  if (!valido && patientData.rut) {
    document.getElementById('rut')?.focus();
    return;
  }

  // Validar otros campos
  if (patientData.telefono && !validarTelefono(patientData.telefono)) {
    document.getElementById('telefono')?.focus();
    return;
  }

  if (patientData.edad && !validarEdad(patientData.edad)) {
    document.getElementById('edad')?.focus();
    return;
  }

  // Mostrar indicador de carga
  setIsSubmitting(true);

  // Simular guardado
  setTimeout(() => {
    console.log("Datos de la ficha (validados):", patientData);
    setIsSubmitting(false);
    
    // Mostrar modal de éxito mejorado
    const modal = document.getElementById('successModal');
    if (modal) modal.classList.remove('hidden');
    // Aumentar tiempo de visualización
    setTimeout(() => {
      if (modal) modal.classList.add('hidden');
    }, 5000);
  }, 1000);
};

// Modificar el modal de éxito
<div id="successModal" className="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
  <div className="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
    <div className="mb-4">
      <svg className="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h3 className="text-lg font-medium text-gray-900 mb-2">¡Ficha Guardada con Éxito!</h3>
    <p className="text-sm text-gray-500 mb-4">
      Los datos del paciente han sido guardados correctamente en el sistema.
    </p>
    <button
      onClick={() => document.getElementById('successModal').classList.add('hidden')}
      className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors"
    >
      Aceptar
    </button>
  </div>
</div>
